---

- name: Gather facts
  delegate_to: "{{ server_ipv4 }}"
  ansible.builtin.setup:
    gather_subset: network

- name: Backup current netplan configuration (Ubuntu)
  delegate_to: "{{ server_ipv4 }}"
  become: true
  ansible.builtin.copy:
    src: /etc/netplan/00-installer-config.yaml
    dest: "/etc/netplan/00-installer-config.yaml.bak.{{ ansible_date_time.iso8601_micro }}"
    remote_src: true
  when: ( ansible_facts['distribution_release'] == 'focal' or ansible_facts['distribution_release'] == 'jammy') and ( set_static_ip | bool )

- name: Set static IP (Ubuntu)
  delegate_to: "{{ server_ipv4 }}"
  become: true
  ansible.builtin.template:
    src: "{{ role_path }}/templates/static_netplan.j2"
    dest: /etc/netplan/00-installer-config.yaml
  when: ( ansible_facts['distribution_release'] == 'focal' or ansible_facts['distribution_release'] == 'jammy') and ( set_static_ip | bool )

- name: Apply netplan configuration (Ubuntu)
  delegate_to: "{{ server_ipv4 }}"
  become: true
  ansible.builtin.shell: | # The sleep here is needed so that ansible can exit the SSH session before the change occurs
      nohup bash -c "sleep 1 && netplan apply" &
  when: ( ansible_facts['distribution_release'] == 'focal' or ansible_facts['distribution_release'] == 'jammy') and ( set_static_ip | bool )

- name: Set static IP (Debian) 1/2
  delegate_to: "{{ server_ipv4 }}"
  become: true
  lineinfile:
    path: /etc/network/interfaces
    regexp: '^iface {{ ansible_default_ipv4.interface }} inet dhcp'
    line: '#iface {{ ansible_default_ipv4.interface }} inet dhcp'
  when: ( ansible_facts['distribution_release'] == 'bullseye' or ansible_facts['distribution_release'] == 'bookworm') and ( set_static_ip | bool )

- name: Set static IP (Debian) 2/2
  delegate_to: "{{ server_ipv4 }}"
  become: true
  blockinfile:
    path: /etc/network/interfaces
    insertafter: '^#iface {{ ansible_default_ipv4.interface }} inet dhcp'
    block: |
      iface {{ ansible_default_ipv4.interface }} inet static
        address {{ static_ipv4_with_mask.split('/')[0] }}
        netmask {{ ansible_default_ipv4.netmask }}
        gateway {{ ansible_default_ipv4.gateway }}
  when: ( ansible_facts['distribution_release'] == 'bullseye' or ansible_facts['distribution_release'] == 'bookworm') and ( set_static_ip | bool )

- name: Apply the new networking configuration (Debian)
  delegate_to: "{{ server_ipv4 }}"
  become: true
  ansible.builtin.shell: |
    nohup bash -c 'sleep 5 && systemctl restart networking' &
  async: 10
  poll: 0
  when: ( ansible_facts['distribution_release'] == 'bullseye' or ansible_facts['distribution_release'] == 'bookworm') and ( set_static_ip | bool )

- name: Wait for SSH to come up
  delegate_to: "{{ server_ipv4_final }}"
  wait_for:
    host: "{{ server_ipv4_final }}"
    port: 22
    state: started
    delay: 5       # Delay the first check by 5 seconds
    timeout: 120   # Fail after 2 minutes
    sleep: 5       # Check every 5 seconds
